name: Documentation

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-documentation:
    name: Build Documentation
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: SwiftyLab/setup-swift@latest
        with:
          swift-version: '6.2'

      - name: Generate Documentation
        run: |
          # Create docs directory
          mkdir -p ./docs

          # Note: swift package generate-documentation requires Swift-DocC plugin
          # which is not included in Swift 6.2 toolchain on macOS by default.
          # Using xcodebuild docbuild as an alternative approach.
          
          # Try to generate documentation using xcodebuild
          if command -v xcodebuild &> /dev/null; then
            echo "Generating documentation with xcodebuild..."
            
            # Generate scheme if needed
            swift package generate-xcodeproj 2>/dev/null || true
            
            # Use xcodebuild docbuild for each target
            for target in J2KCore J2KCodec J2KAccelerate J2KFileFormat JPIP; do
              echo "Generating docs for $target..."
              xcodebuild docbuild \
                -scheme "$target" \
                -destination 'generic/platform=macOS' \
                -derivedDataPath ./.docbuild 2>/dev/null || true
              
              # Copy generated docs if available
              if [ -d "./.docbuild/Build/Products/Debug/$target.doccarchive" ]; then
                mkdir -p "./docs/$target"
                cp -r "./.docbuild/Build/Products/Debug/$target.doccarchive" "./docs/$target/"
              fi
            done
          else
            echo "xcodebuild not available, skipping documentation generation"
          fi

          # Create index page
          cat > ./docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head><meta charset="utf-8"><title>J2KSwift Documentation</title></head>
          <body>
            <h1>J2KSwift Documentation</h1>
            <p>Documentation generation requires Swift-DocC plugin or Xcode.</p>
            <p>To view documentation locally, use: <code>swift package generate-documentation --target [TargetName]</code></p>
            <ul>
              <li>J2KCore - Core data types and utilities</li>
              <li>J2KCodec - JPEG 2000 encoding and decoding</li>
              <li>J2KAccelerate - Hardware-accelerated operations</li>
              <li>J2KFileFormat - File format support (JP2, J2K, etc.)</li>
              <li>JPIP - Network streaming protocol</li>
            </ul>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy:
    name: Deploy to GitHub Pages
    needs: build-documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
